<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>きき耳ずきん</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@200;300&family=Noto+Serif+JP:wght@200;600&family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,200,0,0&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --background: #fdfdfd; --foreground: #1a1a1a; --card: #ffffff; --border: #e4e4e7;
            --muted-foreground: #71717a; --radius-xl: 0.75rem; --font-serif: 'Noto Serif JP', serif; --font-sans: 'Noto Sans JP', sans-serif;
            --accent-color: #eb6101; --reply-bg: #f7f7f7; --danger-color: #ef4444;
        }
        body { font-family: var(--font-sans); background-color: var(--background); color: var(--foreground); margin: 0; padding: 0; line-height: 1.8; display: flex; flex-direction: column; align-items: center; font-weight: 200; -webkit-text-size-adjust: 100%; }
        header { width: 100%; max-width: 48rem; padding: 4rem 1.5rem 1rem; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        h1 { font-family: var(--font-serif); font-size: 1.1rem; font-weight: 200; letter-spacing: 0.3rem; margin: 0; cursor: pointer; }
        .btn-outline { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.75rem; border: 1px solid var(--border); background: white; cursor: pointer; color: var(--foreground); transition: opacity 0.3s; width: fit-content; }
        .btn-danger { color: var(--danger-color); border-color: var(--border); }
        main { width: 100%; max-width: 48rem; display: flex; flex-direction: column; align-items: center; }
        .audio-control-btn { position: sticky; top: 1rem; margin-left: auto; margin-right: 1.5rem; margin-bottom: 1rem; z-index: 100; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); border: 1px solid var(--border); border-radius: 2rem; padding: 0.4rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.65rem; color: var(--muted-foreground); cursor: pointer; }
        #top-view, #mypage-view { width: 100%; display: none; flex-direction: column; align-items: center; }
        #top-view.active, #mypage-view.active { display: flex; }
        #editor-container { width: 100%; display: none; flex-direction: column; align-items: center; }
        .intro-card { background: white; border: 1px solid var(--border); border-radius: var(--radius-xl); padding: 2.5rem 2rem; margin: 0 1.5rem 1rem; max-width: 42rem; box-sizing: border-box; }
        .intro-text { font-family: var(--font-sans); font-size: 0.9rem; color: #333; line-height: 2.5; letter-spacing: 0.05rem; white-space: pre-wrap; }
        .hero-img { width: 100%; max-width: 48rem; height: auto; margin-bottom: 2rem; padding: 0; box-sizing: border-box; }
        
        .editor-box { background: white; border: 1px solid var(--border); border-radius: var(--radius-xl); padding: 1.5rem; width: 100%; max-width: 42rem; box-sizing: border-box; margin-bottom: 2rem; }
        .editor-wrapper { width: calc(100% - 3rem); margin: 0 1.5rem; display: flex; flex-direction: column; align-items: center; }
        input[type="text"], textarea { width: 100%; padding: 0.8rem; border: 1px solid #eee; border-radius: 0.4rem; box-sizing: border-box; font-family: var(--font-sans); font-size: 0.9rem; margin-bottom: 1rem; background: #fafafa; }
        textarea { height: 150px; resize: none; margin-bottom: 1.5rem; }
        
        /* 修正箇所：綴るボタン（Noto Sans JP Light 300） */
        .btn-submit { background: var(--foreground); color: white; padding: 1rem; border-radius: 3rem; width: 100%; border: none; cursor: pointer; font-family: var(--font-sans); font-weight: 300; font-size: 1rem; letter-spacing: 0.2rem; margin-top: 1rem; }
        /* 修正箇所：下書きボタン（Noto Sans JP Light 300） */
        .btn-draft { background: white; color: var(--foreground); border: 1px solid var(--foreground); padding: 0.8rem; border-radius: 3rem; width: 100%; cursor: pointer; font-family: var(--font-sans); font-weight: 300; font-size: 0.9rem; letter-spacing: 0.2rem; margin-top: 0.5rem; }
        /* 修正箇所：やめるボタン（Noto Sans JP Light 300） */
        .btn-cancel { text-align:center; padding:1.5rem 1rem 0; cursor:pointer; font-size:0.8rem; color:var(--muted-foreground); font-family: var(--font-sans); font-weight: 300; }
        
        .pin-actions { display: flex; flex-direction: column; gap: 0.8rem; margin-bottom: 1.5rem; width: 100%; }
        .pin-actions .btn-outline { width: 100%; padding: 0.8rem; box-sizing: border-box; }

        #posts-list, #mypage-posts-list { width: 100%; max-width: 42rem; padding: 1rem 1.5rem 5rem; box-sizing: border-box; }
        .card { background-color: var(--card); border: 1px solid var(--border); border-radius: var(--radius-xl); margin-bottom: 2rem; overflow: hidden; }
        .card-inner { padding: 1.5rem; }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.2rem; }
        .card-header-main { display: flex; flex-direction: column; gap: 0.3rem; flex: 1; }
        /* 修正箇所：場所の名前（Noto Sans JP Light 300） */
        .place-name-bold { font-family: var(--font-sans); font-weight: 300; font-size: 0.95rem; letter-spacing: 0.08rem; line-height: 1.4; }
        .author-info-row { display: flex; align-items: center; gap: 0.8rem; font-size: 0.75rem; color: var(--muted-foreground); }
        
        .card-content { font-family: var(--font-sans); font-size: 0.9rem; line-height: 2; white-space: pre-wrap; color: #333; margin-bottom: 0.5rem; }
        .reply-section { background-color: var(--reply-bg); padding: 1rem; border-top: 1px solid var(--border); display: flex; flex-direction: row; justify-content: center; gap: 1rem; }
        
        .post-map { width: 100%; height: 0; padding-bottom: 56.25%; border-radius: 0.5rem; display: none; margin-top: 0.5rem; border: 1px solid var(--border); position: relative; }
        .post-map .leaflet-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 0.5rem; }
        
        .save-btn { background: none; border: none; cursor: pointer; color: var(--muted-foreground); display: flex; align-items: center; padding: 0.5rem; margin: -0.5rem; }
        .save-btn.active { color: var(--accent-color); font-variation-settings: 'FILL' 1; }
        
        .mypage-title { font-family: var(--font-serif); font-size: 1.1rem; font-weight: 200; letter-spacing: 0.3rem; margin: 2rem 0; text-align:center; }
        
        .mypage-tabs { display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border); width: 100%; max-width: 42rem; }
        .tab-btn { background: none; border: none; padding: 1rem 0.5rem; cursor: pointer; font-size: 0.75rem; color: var(--muted-foreground); white-space: nowrap; }
        .tab-btn.active { color: var(--foreground); border-bottom: 2px solid var(--foreground); }
        .tab-btn.has-drafts { color: var(--accent-color); }
        
        .section-title { font-family: var(--font-serif); font-size: 1.1rem; font-weight: 200; letter-spacing: 0.3rem; margin: 2rem 0 1rem; width: 100%; text-align: center; }
        dialog { border: none; border-radius: var(--radius-xl); padding: 0; width: 95%; max-width: 40rem; }
        dialog::backdrop { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
        #map-selector { width: 100%; height: 350px; background: #eee; }
        .draft-badge { background: #eee; color: #666; font-size: 0.6rem; padding: 0.2rem 0.4rem; border-radius: 0.2rem; margin-right: 0.4rem; display: inline-block; }

        #toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 0.8rem 1.5rem; border-radius: 2rem; font-size: 0.8rem; z-index: 1000; display: none; pointer-events: none; white-space: nowrap; }
        .toast-animation { animation: fadeInOut 3s forwards; }
        @keyframes fadeInOut { 0% { opacity: 0; bottom: 1rem; } 15% { opacity: 1; bottom: 2rem; } 85% { opacity: 1; bottom: 2rem; } 100% { opacity: 0; bottom: 1rem; } }
    </style>
</head>
<body>
    <header>
        <h1 onclick="showView('top-view')">きき耳ずきん</h1>
        <button id="header-btn" class="btn-outline" onclick="toggleMypage()">
            <span id="header-btn-icon" class="material-symbols-outlined" style="font-size: 1rem;">person</span>
            <span id="header-btn-text">マイページ</span>
        </button>
    </header>

    <main>
        <audio id="bgm" loop preload="auto">
            <source src="https://res.cloudinary.com/dh6zibjr8/video/upload/v1770109967/Untitled_1_ehkluw.mp3" type="audio/mpeg">
        </audio>

        <button id="audio-toggle" class="audio-control-btn" onclick="toggleAudio()">
            <span id="audio-icon" class="material-symbols-outlined" style="font-size: 1rem;">volume_off</span>
            <span id="audio-text">静寂の中</span>
        </button>

        <div id="top-view" class="active">
            <img src="https://res.cloudinary.com/dh6zibjr8/image/upload/v1770107819/kikimimitop_fzje9c.png" class="hero-img">
            <div id="intro-card-area" class="intro-card">
                <div class="intro-text">きき耳ずきんをかぶると、街が少しやさしくなる。いつも通っている道のはずなのに、橋のたもとや池のそば、名もない場所から、小さな声が聞こえてくる。それを読んで、心に残ったことを、自分の言葉にしてそっと置いていく。

きき耳ずきんの中には、静かで、あたたかい世界が広がっている。</div>
            </div>

            <div id="action-btn-area" style="text-align: center; margin-bottom: 2rem;">
                <button class="btn-outline" style="padding: 0.8rem 2.5rem; font-size: 0.95rem; font-family: var(--font-serif); letter-spacing: 0.2rem;" onclick="openEditor()">
                    <span class="material-symbols-outlined">edit_note</span>
                    <span>きき耳を残す</span>
                </button>
            </div>

            <div id="editor-container" class="editor-wrapper">
                <div class="editor-box">
                    <input type="text" id="pen-name" placeholder="ペンネーム">
                    <input type="text" id="place-name" placeholder="場所のなまえ（例：〇〇公園のベンチ）">
                    <textarea id="post-content" maxlength="200" placeholder="きき耳したことをおしえてください"></textarea>
                    
                    <div class="pin-actions">
                        <button class="btn-outline" onclick="openMapSelector('current')">
                            <span class="material-symbols-outlined">my_location</span>現在地からピン留め
                        </button>
                        <button class="btn-outline" onclick="openMapSelector('search')">
                            <span class="material-symbols-outlined">location_on</span>場所検索からピン留め
                        </button>
                    </div>
                    
                    <div id="selected-location" style="display:none; margin-bottom:1.5rem; font-size:0.8rem; color:var(--accent-color); align-items:center; gap:0.5rem;">
                        <span class="material-symbols-outlined" style="font-size:1rem;">location_on</span>
                        <span id="location-coords">場所を記録しました</span>
                    </div>

                    <button id="btn-save" class="btn-submit" onclick="submitPost('published')">きき耳したことを綴る</button>
                    <button id="btn-draft" class="btn-draft" onclick="handleDraftSave()">現在地を下書き保存</button>
                    <div class="btn-cancel" onclick="closeEditor()">やめる</div>
                </div>
            </div>

            <div class="section-title">きき耳をたてる</div>
            <div id="posts-list"></div>
        </div>

        <div id="mypage-view">
            <h2 class="mypage-title">私のきき耳ずきん</h2>
            <div class="mypage-tabs">
                <button id="tab-my" class="tab-btn active" onclick="switchTab('my')">わたしのきき耳</button>
                <button id="tab-fav" class="tab-btn" onclick="switchTab('fav')">気になるきき耳</button>
                <button id="tab-draft" class="tab-btn" onclick="switchTab('draft')">下書き保存</button>
            </div>
            <div id="mypage-posts-list"></div>
        </div>

        <div id="toast">メッセージ</div>

        <dialog id="map-dialog">
            <div style="padding: 1rem; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); align-items: center;">
                <span style="font-size:0.9rem;">場所をピン留め</span>
                <button onclick="document.getElementById('map-dialog').close()" style="background:none; border:none; cursor:pointer;"><span class="material-symbols-outlined">close</span></button>
            </div>
            <div id="map-search-bar" style="padding: 0.8rem; display: flex; gap: 0.5rem; background: #f9f9f9; border-bottom: 1px solid var(--border);">
                <input type="text" id="map-search-input" placeholder="場所の名前で検索" style="margin-bottom: 0; flex: 1; padding: 0.5rem;">
                <button class="btn-outline" onclick="searchLocation()" style="padding: 0.5rem 1rem;">検索</button>
            </div>
            <div id="map-selector"></div>
            <div style="padding:1rem; text-align:center;">
                <button onclick="confirmLocation()" style="background:var(--foreground); color:white; padding:0.8rem 2rem; border-radius:2rem; border:none; cursor:pointer; font-family:var(--font-serif);">この場所にする</button>
            </div>
        </dialog>
    </main>

    <script>
        const SUPABASE_URL = 'https://ciklywhqswbujsogqiva.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpa2x5d2hxc3didWpzb2dxaXZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MzAyNzcsImV4cCI6MjA4NDUwNjI3N30._REwuc__qmpW1eQVhfm-RvsoMJCGYXjqtqBVn4w48Oc';
        
        const TILE_URL = 'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png';
        const TILE_ATTRIB = '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>';

        let supabaseClient;
        let posts = [];
        let currentTab = 'my';
        let selectorMap, selectorMarker, selectedLatLng = null;
        let editingDraftId = null;
        const bgm = document.getElementById('bgm');
        let userId = localStorage.getItem('kikimimi_user_id') || ('user_' + Math.random().toString(36).substr(2, 9));
        localStorage.setItem('kikimimi_user_id', userId);

        function playAudio() {
            bgm.play().catch(e => console.log("再生失敗:", e));
            document.getElementById('audio-icon').innerText = 'volume_up';
            document.getElementById('audio-text').innerText = '音を奏でています';
        }
        function pauseAudio() {
            bgm.pause();
            document.getElementById('audio-icon').innerText = 'volume_off';
            document.getElementById('audio-text').innerText = '静寂の中';
        }
        function toggleAudio() { if (bgm.paused) playAudio(); else pauseAudio(); }
        document.addEventListener('visibilitychange', () => { if (document.hidden) pauseAudio(); });

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.display = 'block';
            toast.classList.remove('toast-animation');
            void toast.offsetWidth;
            toast.classList.add('toast-animation');
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        function showView(viewId) {
            document.getElementById('top-view').style.display = 'none';
            document.getElementById('mypage-view').style.display = 'none';
            const target = document.getElementById(viewId);
            if(target) target.style.display = 'flex';
            const btnText = document.getElementById('header-btn-text');
            const btnIcon = document.getElementById('header-btn-icon');
            if (viewId === 'mypage-view') {
                btnText.innerText = 'もどる'; btnIcon.innerText = 'arrow_back'; loadPosts();
            } else {
                btnText.innerText = 'マイページ'; btnIcon.innerText = 'person'; loadPosts();
            }
        }

        function toggleMypage() {
            if (document.getElementById('mypage-view').style.display === 'flex') showView('top-view');
            else showView('mypage-view');
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const tabBtn = document.getElementById(`tab-${tab}`);
            if(tabBtn) tabBtn.classList.add('active');
            renderPosts();
        }

        async function loadPosts() {
            try {
                const { data, error } = await supabaseClient.from('kikimimi_posts').select('*').order('created_at', { ascending: false });
                if (!error) posts = data;
                renderPosts();
            } catch(e) { console.error("データ取得失敗", e); }
        }

        async function handleDraftSave() {
            const btn = document.getElementById('btn-draft');
            if (!selectedLatLng && !editingDraftId) {
                if (navigator.geolocation) {
                    btn.disabled = true; btn.innerText = "現在地を取得中...";
                    navigator.geolocation.getCurrentPosition(async (pos) => {
                        selectedLatLng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        document.getElementById('selected-location').style.display = 'flex';
                        await submitPost('draft');
                        btn.disabled = false; btn.innerText = "現在地を下書き保存";
                    }, (err) => {
                        alert("現在地が取得できませんでした。");
                        btn.disabled = false; btn.innerText = "現在地を下書き保存";
                    });
                } else { alert("GPSが利用できません。"); }
            } else { await submitPost('draft'); }
        }

        async function submitPost(status) {
            const penName = document.getElementById('pen-name').value.trim();
            const placeName = document.getElementById('place-name').value.trim();
            const content = document.getElementById('post-content').value.trim();

            if (status === 'published') {
                if (!penName || !placeName || !content) {
                    showToast("未入力の項目があります");
                    return;
                }
            }

            const btn = (status === 'published') ? document.getElementById('btn-save') : document.getElementById('btn-draft');
            const originalText = (status === 'published') ? "きき耳したことを綴る" : "現在地を下書き保存";
            btn.disabled = true; btn.innerText = "預かり中...";

            const postData = {
                pen_name: penName || (status === 'published' ? 'ななし' : ''),
                place_name: placeName || 'どこかの場所',
                content: content,
                lat: selectedLatLng ? selectedLatLng.lat : 0,
                lng: selectedLatLng ? selectedLatLng.lng : 0,
                status: status,
                user_id: userId
            };

            try {
                let error;
                if (editingDraftId) {
                    const { error: err } = await supabaseClient.from('kikimimi_posts').update(postData).eq('id', editingDraftId);
                    error = err;
                } else {
                    const { error: err } = await supabaseClient.from('kikimimi_posts').insert([postData]);
                    error = err;
                }
                if (!error) {
                    if (status === 'draft') showToast("下書き保存完了");
                    closeEditor();
                    await loadPosts();
                } else { alert("保存に失敗しました"); }
            } catch(e) { alert("通信エラーが発生しました"); }
            btn.disabled = false; btn.innerText = originalText;
        }

        async function deletePost(id) {
            if (!confirm("この下書きを削除してもよろしいですか？")) return;
            try {
                const { error } = await supabaseClient.from('kikimimi_posts').delete().eq('id', id);
                if (!error) {
                    posts = posts.filter(p => p.id !== id);
                    showToast("削除しました");
                    renderPosts();
                } else { 
                    console.error("削除エラー:", error);
                    alert("削除に失敗しました。"); 
                }
            } catch(e) { 
                console.error("削除処理例外:", e);
                alert("通信エラーが発生しました"); 
            }
        }

        function renderPosts() {
            const topList = document.getElementById('posts-list');
            const mypageList = document.getElementById('mypage-posts-list');
            const draftTab = document.getElementById('tab-draft');
            if (!topList) return;

            const publicPosts = posts.filter(p => p.status === 'published').slice(0, 30);
            topList.innerHTML = publicPosts.length ? publicPosts.map(post => renderCard(post, 'top')).join('') : '<p style="font-size:0.8rem; color:#999; text-align:center; padding:2rem;">まだきき耳がありません</p>';

            if (mypageList) {
                const myDrafts = posts.filter(p => p.user_id === userId && p.status === 'draft');
                if (myDrafts.length > 0) draftTab.classList.add('has-drafts'); else draftTab.classList.remove('has-drafts');
                let filtered = [];
                if (currentTab === 'my') filtered = posts.filter(p => p.user_id === userId && p.status === 'published');
                if (currentTab === 'fav') {
                    const favIds = JSON.parse(localStorage.getItem('kikimimi_favs') || '[]');
                    filtered = posts.filter(p => favIds.includes(String(p.id)));
                }
                if (currentTab === 'draft') filtered = myDrafts;
                mypageList.innerHTML = filtered.length ? filtered.map(post => renderCard(post, 'my')).join('') : '<p style="font-size:0.8rem; color:#999; text-align:center; padding:2rem;">ここにはまだ何もありません</p>';
            }
        }

        function renderCard(post, suffix) {
            const isDraft = post.status === 'draft';
            const favIds = JSON.parse(localStorage.getItem('kikimimi_favs') || '[]');
            const isFav = favIds.includes(String(post.id));
            const dateStr = new Date(post.created_at).toLocaleDateString();
            
            return `
                <div class="card">
                    <div class="card-inner">
                        <div class="card-header">
                            <div class="card-header-main">
                                <div class="place-name-bold">
                                    ${isDraft ? '<span class="draft-badge">下書き</span>' : ''}${post.place_name}
                                </div>
                                <div class="author-info-row">
                                    <span>@${post.pen_name || '...'}</span>
                                    ${!isDraft ? `<span>｜</span><span>${dateStr}</span>` : ''}
                                </div>
                            </div>
                            ${!isDraft ? `
                                <button class="save-btn ${isFav ? 'active' : ''}" onclick="toggleFav('${post.id}')">
                                    <span class="material-symbols-outlined" style="font-size: 1.2rem;">bookmark</span>
                                </button>
                            ` : ''}
                        </div>
                        <div class="card-content">${post.content || (isDraft ? '（言葉はまだ綴られていません）' : '')}</div>
                    </div>
                    <div class="reply-section">
                        ${isDraft ? `
                            <button class="btn-outline" onclick="editDraft(${post.id})"><span class="material-symbols-outlined" style="font-size: 1rem;">edit</span><span>言葉を綴る</span></button>
                            <button class="btn-outline btn-danger" onclick="deletePost(${post.id})"><span class="material-symbols-outlined" style="font-size: 1rem;">delete</span><span>削除</span></button>
                        ` : `
                            <button id="btn-map-${suffix}-${post.id}" class="btn-outline" onclick="showPostMap(${post.id}, ${post.lat}, ${post.lng}, '${suffix}')"><span class="material-symbols-outlined" style="font-size: 1rem;">map</span><span>場所を確認</span></button>
                            <div id="map-${suffix}-${post.id}" class="post-map"></div>
                        `}
                    </div>
                </div>`;
        }

        function editDraft(id) {
            const draft = posts.find(p => p.id === id);
            if (!draft) return;
            editingDraftId = id;
            selectedLatLng = { lat: draft.lat, lng: draft.lng };
            document.getElementById('pen-name').value = draft.pen_name || '';
            document.getElementById('place-name').value = draft.place_name || '';
            document.getElementById('post-content').value = draft.content || '';
            if(selectedLatLng && selectedLatLng.lat !== 0) {
                document.getElementById('selected-location').style.display = 'flex';
            }
            showView('top-view'); openEditor();
            document.getElementById('editor-container').scrollIntoView({ behavior: 'smooth' });
        }

        function toggleFav(id) {
            let favs = JSON.parse(localStorage.getItem('kikimimi_favs') || '[]');
            id = String(id);
            if (favs.includes(id)) favs = favs.filter(f => f !== id); else favs.push(id);
            localStorage.setItem('kikimimi_favs', JSON.stringify(favs));
            renderPosts();
        }

        function showPostMap(id, lat, lng, suffix) {
            const mapId = `map-${suffix}-${id}`;
            const mapContainer = document.getElementById(mapId);
            if(!mapContainer) return;
            mapContainer.style.display = 'block';
            document.getElementById(`btn-map-${suffix}-${id}`).style.display = 'none';
            
            const map = L.map(mapId).setView([lat, lng], 13);
            L.tileLayer(TILE_URL, { 
                attribution: TILE_ATTRIB, 
                maxZoom: 18,
                detectRetina: true 
            }).addTo(map);
            
            L.marker([lat, lng]).addTo(map);
            setTimeout(() => { map.invalidateSize(); }, 200);
        }

        function openMapSelector(mode) {
            document.getElementById('map-dialog').showModal();
            if (!selectorMap) {
                selectorMap = L.map('map-selector').setView([35.6812, 139.7671], 13);
                L.tileLayer(TILE_URL, { 
                    attribution: TILE_ATTRIB, 
                    maxZoom: 18,
                    detectRetina: true 
                }).addTo(selectorMap);
                selectorMap.on('click', e => updateSelectorMarker(e.latlng));
            }
            document.getElementById('map-search-bar').style.display = (mode === 'search') ? 'flex' : 'none';
            if (mode === 'current' && navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    selectorMap.setView(latlng, 13); updateSelectorMarker(latlng);
                });
            }
            setTimeout(() => { selectorMap.invalidateSize(); }, 300);
        }

        function updateSelectorMarker(latlng) {
            if (selectorMarker) selectorMap.removeLayer(selectorMarker);
            selectorMarker = L.marker(latlng).addTo(selectorMap);
            selectedLatLng = latlng;
        }

        async function searchLocation() {
            const query = document.getElementById('map-search-input').value;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
            const data = await res.json();
            if (data.length > 0) {
                const latlng = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                selectorMap.setView(latlng, 13); updateSelectorMarker(latlng);
            }
        }

        function confirmLocation() { if (selectedLatLng) { document.getElementById('selected-location').style.display = 'flex'; document.getElementById('map-dialog').close(); } }
        function openEditor() { 
            document.getElementById('intro-card-area').style.display = 'none'; 
            document.getElementById('action-btn-area').style.display = 'none'; 
            document.getElementById('editor-container').style.display = 'flex'; 
            if (bgm.paused) playAudio();
        }
        function closeEditor() { 
            document.getElementById('intro-card-area').style.display = 'block'; 
            document.getElementById('action-btn-area').style.display = 'block'; 
            document.getElementById('editor-container').style.display = 'none'; 
            editingDraftId = null; 
            document.getElementById('pen-name').value = ''; 
            document.getElementById('place-name').value = ''; 
            document.getElementById('post-content').value = ''; 
            document.getElementById('selected-location').style.display = 'none'; 
            selectedLatLng = null; 
        }

        document.addEventListener('DOMContentLoaded', () => {
            try { pauseAudio(); supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); loadPosts(); } 
            catch(e) { console.error("初期化エラー", e); }
        });
    </script>
</body>
</html>
